"""
OWASP Top 10 Penetration Testing Suite
Comprehensive security testing for AI/LLM applications
"""

import os
import sys
import time
import logging
from typing import List, Dict, Any
from dataclasses import dataclass
from enum import Enum
import requests

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

class OWASPStatus(Enum):
    VULNERABLE = "VULNERABLE"
    SECURE = "SECURE"
    INCONCLUSIVE = "INCONCLUSIVE"
    NOT_APPLICABLE = "NOT_APPLICABLE"

@dataclass
class PentestResult:
    """Penetration test result"""
    owasp_category: str
    test_name: str
    status: OWASPStatus
    severity: str
    description: str
    evidence: Dict[str, Any]
    recommendation: str
    timestamp: str

class OWASPPentestSuite:
    """
    OWASP Top 10 Penetration Testing Suite
    
    OWASP Top 10 Categories:
    1. Broken Access Control
    2. Cryptographic Failures
    3. Injection
    4. Insecure Design
    5. Security Misconfiguration
    6. Vulnerable Components
    7. Authentication Failures
    8. Software/Data Integrity Failures
    9. Security Logging Failures
    10. Server-Side Request Forgery (SSRF)
    """
    
    def __init__(self, base_url: str = "http://localhost:5001"):
        self.base_url = base_url
        self.results: List[PentestResult] = []
        self.api_endpoint = f"{base_url}/api/v1/process"
    
    def run_all_tests(self) -> Dict[str, Any]:
        """Execute all OWASP Top 10 tests"""
        logger.info("Starting OWASP Top 10 penetration testing...")
        
        test_suites = [
            ("A01: Broken Access Control", self.test_broken_access_control),
            ("A02: Cryptographic Failures", self.test_cryptographic_failures),
            ("A03: Injection", self.test_injection),
            ("A04: Insecure Design", self.test_insecure_design),
            ("A05: Security Misconfiguration", self.test_security_misconfiguration),
            ("A06: Vulnerable Components", self.test_vulnerable_components),
            ("A07: Authentication Failures", self.test_authentication_failures),
            ("A08: Software/Data Integrity Failures", self.test_integrity_failures),
            ("A09: Security Logging Failures", self.test_logging_failures),
            ("A10: Server-Side Request Forgery", self.test_ssrf),
        ]
        
        for suite_name, test_func in test_suites:
            logger.info(f"Testing {suite_name}...")
            try:
                test_func()
            except Exception as e:
                logger.error(f"{suite_name} failed with error: {str(e)}")
                self.results.append(PentestResult(
                    owasp_category=suite_name,
                    test_name="Test Execution Error",
                    status=OWASPStatus.INCONCLUSIVE,
                    severity="INFO",
                    description=f"Test suite crashed: {str(e)}",
                    evidence={'error': str(e)},
                    recommendation="Review test implementation",
                    timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
                ))
        
        return self._generate_report()
    
    def test_broken_access_control(self):
        """A01: Test for broken access control"""
        logger.info("Testing A01: Broken Access Control...")
        
        tests = [
            {
                "name": "Unauthorized endpoint access",
                "test": self._test_unauthorized_access
            },
            {
                "name": "Privilege escalation",
                "test": self._test_privilege_escalation
            },
            {
                "name": "Directory traversal",
                "test": self._test_directory_traversal
            }
        ]
        
        for test_case in tests:
            try:
                result = test_case['test']()
                self.results.append(result)
            except Exception as e:
                self.results.append(PentestResult(
                    owasp_category="A01: Broken Access Control",
                    test_name=test_case['name'],
                    status=OWASPStatus.INCONCLUSIVE,
                    severity="MEDIUM",
                    description=f"Test error: {str(e)}",
                    evidence={'error': str(e)},
                    recommendation="Review access control implementation",
                    timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
                ))
    
    def test_cryptographic_failures(self):
        """A02: Test for cryptographic failures"""
        logger.info("Testing A02: Cryptographic Failures...")
        
        tests = [
            {
                "name": "Insecure data transmission",
                "test": self._test_insecure_transmission
            },
            {
                "name": "Weak encryption",
                "test": self._test_weak_encryption
            },
            {
                "name": "Sensitive data exposure",
                "test": self._test_sensitive_data_exposure
            }
        ]
        
        for test_case in tests:
            try:
                result = test_case['test']()
                self.results.append(result)
            except Exception as e:
                self.results.append(PentestResult(
                    owasp_category="A02: Cryptographic Failures",
                    test_name=test_case['name'],
                    status=OWASPStatus.INCONCLUSIVE,
                    severity="HIGH",
                    description=f"Test error: {str(e)}",
                    evidence={'error': str(e)},
                    recommendation="Review cryptographic implementation",
                    timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
                ))
    
    def test_injection(self):
        """A03: Test for injection vulnerabilities"""
        logger.info("Testing A03: Injection...")
        
        injection_payloads = [
            {"type": "SQL Injection", "payload": "'; DROP TABLE users; --"},
            {"type": "NoSQL Injection", "payload": '{"$ne": null}'},
            {"type": "Command Injection", "payload": "; ls -la"},
            {"type": "LDAP Injection", "payload": "*)(&"},
            {"type": "XPath Injection", "payload": "' or '1'='1"},
            {"type": "Template Injection", "payload": "{{7*7}}"},
            {"type": "Code Injection", "payload": "__import__('os').system('ls')"},
        ]
        
        for payload_info in injection_payloads:
            try:
                result = self._test_injection_payload(payload_info)
                self.results.append(result)
            except Exception as e:
                self.results.append(PentestResult(
                    owasp_category="A03: Injection",
                    test_name=payload_info['type'],
                    status=OWASPStatus.INCONCLUSIVE,
                    severity="CRITICAL",
                    description=f"Test error: {str(e)}",
                    evidence={'error': str(e)},
                    recommendation="Implement input validation and parameterized queries",
                    timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
                ))
    
    def test_insecure_design(self):
        """A04: Test for insecure design patterns"""
        logger.info("Testing A04: Insecure Design...")
        
        tests = [
            {
                "name": "Missing security controls",
                "test": self._test_missing_security_controls
            },
            {
                "name": "Weak business logic",
                "test": self._test_weak_business_logic
            },
            {
                "name": "Insufficient rate limiting",
                "test": self._test_rate_limiting_design
            }
        ]
        
        for test_case in tests:
            try:
                result = test_case['test']()
                self.results.append(result)
            except Exception as e:
                self.results.append(PentestResult(
                    owasp_category="A04: Insecure Design",
                    test_name=test_case['name'],
                    status=OWASPStatus.INCONCLUSIVE,
                    severity="MEDIUM",
                    description=f"Test error: {str(e)}",
                    evidence={'error': str(e)},
                    recommendation="Review application design and security architecture",
                    timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
                ))
    
    def test_security_misconfiguration(self):
        """A05: Test for security misconfiguration"""
        logger.info("Testing A05: Security Misconfiguration...")
        
        tests = [
            {
                "name": "Default credentials",
                "test": self._test_default_credentials
            },
            {
                "name": "Debug mode enabled",
                "test": self._test_debug_mode
            },
            {
                "name": "Error message disclosure",
                "test": self._test_error_disclosure
            },
            {
                "name": "CORS misconfiguration",
                "test": self._test_cors_misconfiguration
            }
        ]
        
        for test_case in tests:
            try:
                result = test_case['test']()
                self.results.append(result)
            except Exception as e:
                self.results.append(PentestResult(
                    owasp_category="A05: Security Misconfiguration",
                    test_name=test_case['name'],
                    status=OWASPStatus.INCONCLUSIVE,
                    severity="MEDIUM",
                    description=f"Test error: {str(e)}",
                    evidence={'error': str(e)},
                    recommendation="Review security configuration and hardening",
                    timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
                ))
    
    def test_vulnerable_components(self):
        """A06: Test for vulnerable components"""
        logger.info("Testing A06: Vulnerable Components...")
        
        result = PentestResult(
            owasp_category="A06: Vulnerable Components",
            test_name="Dependency vulnerability scan",
            status=OWASPStatus.INCONCLUSIVE,
            severity="HIGH",
            description="Dependency scanning requires external tools (safety, bandit, etc.)",
            evidence={'note': 'Run: pip install safety && safety check'},
            recommendation="Regularly update dependencies and scan for known vulnerabilities",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
        self.results.append(result)
    
    def test_authentication_failures(self):
        """A07: Test for authentication failures"""
        logger.info("Testing A07: Authentication Failures...")
        
        tests = [
            {
                "name": "Weak password policy",
                "test": self._test_weak_passwords
            },
            {
                "name": "Session management",
                "test": self._test_session_management
            },
            {
                "name": "Brute force protection",
                "test": self._test_brute_force_protection
            }
        ]
        
        for test_case in tests:
            try:
                result = test_case['test']()
                self.results.append(result)
            except Exception as e:
                self.results.append(PentestResult(
                    owasp_category="A07: Authentication Failures",
                    test_name=test_case['name'],
                    status=OWASPStatus.INCONCLUSIVE,
                    severity="HIGH",
                    description=f"Test error: {str(e)}",
                    evidence={'error': str(e)},
                    recommendation="Implement strong authentication and session management",
                    timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
                ))
    
    def test_integrity_failures(self):
        """A08: Test for software/data integrity failures"""
        logger.info("Testing A08: Software/Data Integrity Failures...")
        
        tests = [
            {
                "name": "Code integrity",
                "test": self._test_code_integrity
            },
            {
                "name": "Data tampering",
                "test": self._test_data_tampering
            },
            {
                "name": "Supply chain security",
                "test": self._test_supply_chain
            }
        ]
        
        for test_case in tests:
            try:
                result = test_case['test']()
                self.results.append(result)
            except Exception as e:
                self.results.append(PentestResult(
                    owasp_category="A08: Software/Data Integrity Failures",
                    test_name=test_case['name'],
                    status=OWASPStatus.INCONCLUSIVE,
                    severity="HIGH",
                    description=f"Test error: {str(e)}",
                    evidence={'error': str(e)},
                    recommendation="Implement code signing and integrity checks",
                    timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
                ))
    
    def test_logging_failures(self):
        """A09: Test for security logging failures"""
        logger.info("Testing A09: Security Logging Failures...")
        
        tests = [
            {
                "name": "Logging sensitive data",
                "test": self._test_sensitive_logging
            },
            {
                "name": "Insufficient logging",
                "test": self._test_insufficient_logging
            },
            {
                "name": "Log injection",
                "test": self._test_log_injection
            }
        ]
        
        for test_case in tests:
            try:
                result = test_case['test']()
                self.results.append(result)
            except Exception as e:
                self.results.append(PentestResult(
                    owasp_category="A09: Security Logging Failures",
                    test_name=test_case['name'],
                    status=OWASPStatus.INCONCLUSIVE,
                    severity="MEDIUM",
                    description=f"Test error: {str(e)}",
                    evidence={'error': str(e)},
                    recommendation="Implement comprehensive security logging and monitoring",
                    timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
                ))
    
    def test_ssrf(self):
        """A10: Test for Server-Side Request Forgery"""
        logger.info("Testing A10: Server-Side Request Forgery...")
        
        ssrf_payloads = [
            "http://localhost:22",
            "http://127.0.0.1:3306",
            "file:///etc/passwd",
            "http://169.254.169.254/latest/meta-data/",
            "gopher://localhost:6379",
        ]
        
        for payload in ssrf_payloads:
            try:
                result = self._test_ssrf_payload(payload)
                self.results.append(result)
            except Exception as e:
                self.results.append(PentestResult(
                    owasp_category="A10: Server-Side Request Forgery",
                    test_name=f"SSRF: {payload}",
                    status=OWASPStatus.INCONCLUSIVE,
                    severity="HIGH",
                    description=f"Test error: {str(e)}",
                    evidence={'error': str(e)},
                    recommendation="Validate and whitelist allowed URLs",
                    timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
                ))
    
    def _test_unauthorized_access(self) -> PentestResult:
        """Test unauthorized endpoint access"""
        try:
            admin_endpoints = ['/admin', '/api/admin', '/internal', '/debug']
            vulnerable = False
            
            for endpoint in admin_endpoints:
                try:
                    response = requests.get(f"{self.base_url}{endpoint}", timeout=5)
                    if response.status_code == 200:
                        vulnerable = True
                        break
                except:
                    pass
            
            status = OWASPStatus.VULNERABLE if vulnerable else OWASPStatus.SECURE
            
            return PentestResult(
                owasp_category="A01: Broken Access Control",
                test_name="Unauthorized endpoint access",
                status=status,
                severity="HIGH" if vulnerable else "INFO",
                description=f"Unauthorized access {'detected' if vulnerable else 'not detected'}",
                evidence={'vulnerable': vulnerable, 'endpoints_tested': admin_endpoints},
                recommendation="Implement proper access control and authentication",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception as e:
            return PentestResult(
                owasp_category="A01: Broken Access Control",
                test_name="Unauthorized endpoint access",
                status=OWASPStatus.INCONCLUSIVE,
                severity="MEDIUM",
                description=f"Error: {str(e)}",
                evidence={'error': str(e)},
                recommendation="Review access control implementation",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
    
    def _test_privilege_escalation(self) -> PentestResult:
        """Test privilege escalation"""
        return PentestResult(
            owasp_category="A01: Broken Access Control",
            test_name="Privilege escalation",
            status=OWASPStatus.NOT_APPLICABLE,
            severity="INFO",
            description="Privilege escalation testing requires authenticated session (placeholder)",
            evidence={'note': 'Requires user authentication system'},
            recommendation="Implement role-based access control (RBAC)",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_directory_traversal(self) -> PentestResult:
        """Test directory traversal"""
        traversal_payloads = ["../../../etc/passwd", "..\\..\\windows\\system32"]
        vulnerable = False
        
        for payload in traversal_payloads:
            try:
                response = requests.get(f"{self.base_url}/api/v1/process?file={payload}", timeout=5)
                if "root:" in response.text or "Administrator" in response.text:
                    vulnerable = True
                    break
            except:
                pass
        
        status = OWASPStatus.VULNERABLE if vulnerable else OWASPStatus.SECURE
        
        return PentestResult(
            owasp_category="A01: Broken Access Control",
            test_name="Directory traversal",
            status=status,
            severity="HIGH" if vulnerable else "INFO",
            description=f"Directory traversal {'vulnerable' if vulnerable else 'secure'}",
            evidence={'vulnerable': vulnerable, 'payloads_tested': traversal_payloads},
            recommendation="Validate and sanitize file paths",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_insecure_transmission(self) -> PentestResult:
        """Test insecure data transmission"""
        is_https = self.base_url.startswith('https://')
        status = OWASPStatus.VULNERABLE if not is_https else OWASPStatus.SECURE
        
        return PentestResult(
            owasp_category="A02: Cryptographic Failures",
            test_name="Insecure data transmission",
            status=status,
            severity="HIGH" if not is_https else "INFO",
            description=f"HTTPS {'not' if not is_https else ''} enforced",
            evidence={'https_enforced': is_https, 'url': self.base_url},
            recommendation="Enforce HTTPS/TLS for all communications",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_weak_encryption(self) -> PentestResult:
        """Test weak encryption"""
        return PentestResult(
            owasp_category="A02: Cryptographic Failures",
            test_name="Weak encryption",
            status=OWASPStatus.INCONCLUSIVE,
            severity="MEDIUM",
            description="Encryption strength analysis requires SSL/TLS testing tools",
            evidence={'note': 'Use tools like SSL Labs, testssl.sh'},
            recommendation="Use strong encryption algorithms (TLS 1.2+, AES-256)",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_sensitive_data_exposure(self) -> PentestResult:
        """Test sensitive data exposure"""
        sensitive_patterns = ['password', 'api_key', 'secret', 'token', 'ssn', 'credit_card']
        
        try:
            response = requests.get(f"{self.base_url}/health", timeout=5)
            response_text = response.text.lower()
            
            exposed = any(pattern in response_text for pattern in sensitive_patterns)
            status = OWASPStatus.VULNERABLE if exposed else OWASPStatus.SECURE
            
            return PentestResult(
                owasp_category="A02: Cryptographic Failures",
                test_name="Sensitive data exposure",
                status=status,
                severity="CRITICAL" if exposed else "INFO",
                description=f"Sensitive data {'exposed' if exposed else 'not exposed'} in responses",
                evidence={'exposed': exposed, 'patterns_checked': sensitive_patterns},
                recommendation="Never expose sensitive data in API responses or logs",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception as e:
            return PentestResult(
                owasp_category="A02: Cryptographic Failures",
                test_name="Sensitive data exposure",
                status=OWASPStatus.INCONCLUSIVE,
                severity="MEDIUM",
                description=f"Error: {str(e)}",
                evidence={'error': str(e)},
                recommendation="Review API responses for sensitive data exposure",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
    
    def _test_injection_payload(self, payload_info: Dict) -> PentestResult:
        """Test specific injection payload"""
        try:
            response = requests.post(
                self.api_endpoint,
                json={"text": payload_info['payload']},
                timeout=5
            )
            
            response_text = response.text.lower()
            vulnerable_indicators = [
                'error', 'syntax', 'mysql', 'postgresql', 'mongo',
                'command', 'executed', 'permission denied'
            ]
            
            vulnerable = any(indicator in response_text for indicator in vulnerable_indicators)
            status = OWASPStatus.VULNERABLE if vulnerable else OWASPStatus.SECURE
            
            return PentestResult(
                owasp_category="A03: Injection",
                test_name=payload_info['type'],
                status=status,
                severity="CRITICAL" if vulnerable else "INFO",
                description=f"{payload_info['type']} {'vulnerable' if vulnerable else 'secure'}",
                evidence={
                    'vulnerable': vulnerable,
                    'payload': payload_info['payload'],
                    'response_status': response.status_code
                },
                recommendation="Use parameterized queries and input validation",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception as e:
            return PentestResult(
                owasp_category="A03: Injection",
                test_name=payload_info['type'],
                status=OWASPStatus.INCONCLUSIVE,
                severity="HIGH",
                description=f"Error: {str(e)}",
                evidence={'error': str(e), 'payload': payload_info['payload']},
                recommendation="Implement comprehensive input validation",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
    
    def _test_missing_security_controls(self) -> PentestResult:
        """Test for missing security controls"""
        controls_checked = {
            'rate_limiting': False,
            'input_validation': False,
            'error_handling': False
        }
        
        try:
            response = requests.post(
                self.api_endpoint,
                json={"text": "test"},
                timeout=5
            )
            controls_checked['error_handling'] = response.status_code in [200, 400, 500]
            
            rapid_requests = 10
            success_count = 0
            for _ in range(rapid_requests):
                r = requests.post(self.api_endpoint, json={"text": "test"}, timeout=2)
                if r.status_code == 200:
                    success_count += 1
            
            controls_checked['rate_limiting'] = success_count < rapid_requests
            
            missing_controls = [k for k, v in controls_checked.items() if not v]
            vulnerable = len(missing_controls) > 0
            status = OWASPStatus.VULNERABLE if vulnerable else OWASPStatus.SECURE
            
            return PentestResult(
                owasp_category="A04: Insecure Design",
                test_name="Missing security controls",
                status=status,
                severity="HIGH" if vulnerable else "INFO",
                description=f"Missing controls: {', '.join(missing_controls) if missing_controls else 'None'}",
                evidence={'controls_checked': controls_checked, 'missing': missing_controls},
                recommendation="Implement comprehensive security controls",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception as e:
            return PentestResult(
                owasp_category="A04: Insecure Design",
                test_name="Missing security controls",
                status=OWASPStatus.INCONCLUSIVE,
                severity="MEDIUM",
                description=f"Error: {str(e)}",
                evidence={'error': str(e)},
                recommendation="Review security architecture",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
    
    def _test_weak_business_logic(self) -> PentestResult:
        """Test weak business logic"""
        return PentestResult(
            owasp_category="A04: Insecure Design",
            test_name="Weak business logic",
            status=OWASPStatus.INCONCLUSIVE,
            severity="MEDIUM",
            description="Business logic testing requires domain knowledge (placeholder)",
            evidence={'note': 'Requires manual review of business logic'},
            recommendation="Review business logic for security implications",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_rate_limiting_design(self) -> PentestResult:
        """Test rate limiting design"""
        try:
            rapid_requests = 20
            success_count = 0
            
            for _ in range(rapid_requests):
                try:
                    response = requests.post(
                        self.api_endpoint,
                        json={"text": "test"},
                        timeout=2
                    )
                    if response.status_code == 200:
                        success_count += 1
                except:
                    pass
            
            vulnerable = success_count >= rapid_requests * 0.8
            status = OWASPStatus.VULNERABLE if vulnerable else OWASPStatus.SECURE
            
            return PentestResult(
                owasp_category="A04: Insecure Design",
                test_name="Insufficient rate limiting",
                status=status,
                severity="MEDIUM" if vulnerable else "INFO",
                description=f"Rate limiting {'insufficient' if vulnerable else 'adequate'}",
                evidence={'requests': rapid_requests, 'successful': success_count},
                recommendation="Implement proper rate limiting",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception as e:
            return PentestResult(
                owasp_category="A04: Insecure Design",
                test_name="Insufficient rate limiting",
                status=OWASPStatus.INCONCLUSIVE,
                severity="MEDIUM",
                description=f"Error: {str(e)}",
                evidence={'error': str(e)},
                recommendation="Implement rate limiting",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
    
    def _test_default_credentials(self) -> PentestResult:
        """Test default credentials"""
        return PentestResult(
            owasp_category="A05: Security Misconfiguration",
            test_name="Default credentials",
            status=OWASPStatus.NOT_APPLICABLE,
            severity="INFO",
            description="Default credentials testing requires authentication endpoints (placeholder)",
            evidence={'note': 'No authentication endpoints found'},
            recommendation="Change all default credentials",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_debug_mode(self) -> PentestResult:
        """Test debug mode"""
        try:
            response = requests.get(f"{self.base_url}/health", timeout=5)
            debug_indicators = ['debug', 'trace', 'development', 'test']
            response_text = response.text.lower()
            
            debug_enabled = any(indicator in response_text for indicator in debug_indicators)
            status = OWASPStatus.VULNERABLE if debug_enabled else OWASPStatus.SECURE
            
            return PentestResult(
                owasp_category="A05: Security Misconfiguration",
                test_name="Debug mode enabled",
                status=status,
                severity="MEDIUM" if debug_enabled else "INFO",
                description=f"Debug mode {'enabled' if debug_enabled else 'disabled'}",
                evidence={'debug_enabled': debug_enabled},
                recommendation="Disable debug mode in production",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception as e:
            return PentestResult(
                owasp_category="A05: Security Misconfiguration",
                test_name="Debug mode enabled",
                status=OWASPStatus.INCONCLUSIVE,
                severity="MEDIUM",
                description=f"Error: {str(e)}",
                evidence={'error': str(e)},
                recommendation="Ensure debug mode is disabled in production",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
    
    def _test_error_disclosure(self) -> PentestResult:
        """Test error message disclosure"""
        try:
            response = requests.post(
                self.api_endpoint,
                json={"invalid": "data"},
                timeout=5
            )
            
            error_indicators = [
                'stack trace', 'traceback', 'file:', 'line:',
                'exception', 'error at', 'sql error', 'database'
            ]
            
            response_text = response.text.lower()
            discloses_info = any(indicator in response_text for indicator in error_indicators)
            status = OWASPStatus.VULNERABLE if discloses_info else OWASPStatus.SECURE
            
            return PentestResult(
                owasp_category="A05: Security Misconfiguration",
                test_name="Error message disclosure",
                status=status,
                severity="MEDIUM" if discloses_info else "INFO",
                description=f"Error messages {'disclose' if discloses_info else 'do not disclose'} sensitive info",
                evidence={'discloses_info': discloses_info, 'status_code': response.status_code},
                recommendation="Use generic error messages in production",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception as e:
            return PentestResult(
                owasp_category="A05: Security Misconfiguration",
                test_name="Error message disclosure",
                status=OWASPStatus.INCONCLUSIVE,
                severity="MEDIUM",
                description=f"Error: {str(e)}",
                evidence={'error': str(e)},
                recommendation="Review error handling",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
    
    def _test_cors_misconfiguration(self) -> PentestResult:
        """Test CORS misconfiguration"""
        try:
            response = requests.options(
                self.api_endpoint,
                headers={'Origin': 'https://evil.com'},
                timeout=5
            )
            
            cors_headers = response.headers.get('Access-Control-Allow-Origin', '')
            vulnerable = cors_headers == '*' or 'evil.com' in cors_headers
            
            status = OWASPStatus.VULNERABLE if vulnerable else OWASPStatus.SECURE
            
            return PentestResult(
                owasp_category="A05: Security Misconfiguration",
                test_name="CORS misconfiguration",
                status=status,
                severity="MEDIUM" if vulnerable else "INFO",
                description=f"CORS {'misconfigured' if vulnerable else 'secure'}",
                evidence={'cors_header': cors_headers, 'vulnerable': vulnerable},
                recommendation="Configure CORS properly with specific origins",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception as e:
            return PentestResult(
                owasp_category="A05: Security Misconfiguration",
                test_name="CORS misconfiguration",
                status=OWASPStatus.INCONCLUSIVE,
                severity="MEDIUM",
                description=f"Error: {str(e)}",
                evidence={'error': str(e)},
                recommendation="Review CORS configuration",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
    
    def _test_weak_passwords(self) -> PentestResult:
        """Test weak password policy"""
        return PentestResult(
            owasp_category="A07: Authentication Failures",
            test_name="Weak password policy",
            status=OWASPStatus.NOT_APPLICABLE,
            severity="INFO",
            description="Password policy testing requires authentication system (placeholder)",
            evidence={'note': 'No authentication endpoints'},
            recommendation="Enforce strong password policies",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_session_management(self) -> PentestResult:
        """Test session management"""
        return PentestResult(
            owasp_category="A07: Authentication Failures",
            test_name="Session management",
            status=OWASPStatus.NOT_APPLICABLE,
            severity="INFO",
            description="Session management testing requires authentication (placeholder)",
            evidence={'note': 'No session management found'},
            recommendation="Implement secure session management",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_brute_force_protection(self) -> PentestResult:
        """Test brute force protection"""
        return PentestResult(
            owasp_category="A07: Authentication Failures",
            test_name="Brute force protection",
            status=OWASPStatus.NOT_APPLICABLE,
            severity="INFO",
            description="Brute force testing requires authentication (placeholder)",
            evidence={'note': 'No authentication endpoints'},
            recommendation="Implement account lockout and rate limiting",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_code_integrity(self) -> PentestResult:
        """Test code integrity"""
        return PentestResult(
            owasp_category="A08: Software/Data Integrity Failures",
            test_name="Code integrity",
            status=OWASPStatus.INCONCLUSIVE,
            severity="MEDIUM",
            description="Code integrity requires code signing verification (placeholder)",
            evidence={'note': 'Implement code signing and integrity checks'},
            recommendation="Implement code signing and integrity verification",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_data_tampering(self) -> PentestResult:
        """Test data tampering"""
        return PentestResult(
            owasp_category="A08: Software/Data Integrity Failures",
            test_name="Data tampering",
            status=OWASPStatus.INCONCLUSIVE,
            severity="MEDIUM",
            description="Data tampering testing requires integrity checks (placeholder)",
            evidence={'note': 'Implement data integrity checks'},
            recommendation="Implement data integrity verification and checksums",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_supply_chain(self) -> PentestResult:
        """Test supply chain security"""
        return PentestResult(
            owasp_category="A08: Software/Data Integrity Failures",
            test_name="Supply chain security",
            status=OWASPStatus.INCONCLUSIVE,
            severity="HIGH",
            description="Supply chain testing requires dependency scanning (placeholder)",
            evidence={'note': 'Run: pip install safety && safety check'},
            recommendation="Regularly audit dependencies and use verified sources",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_sensitive_logging(self) -> PentestResult:
        """Test sensitive data in logs"""
        return PentestResult(
            owasp_category="A09: Security Logging Failures",
            test_name="Logging sensitive data",
            status=OWASPStatus.INCONCLUSIVE,
            severity="MEDIUM",
            description="Log analysis requires log file access (placeholder)",
            evidence={'note': 'Review log files for sensitive data'},
            recommendation="Never log passwords, tokens, or sensitive data",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_insufficient_logging(self) -> PentestResult:
        """Test insufficient logging"""
        return PentestResult(
            owasp_category="A09: Security Logging Failures",
            test_name="Insufficient logging",
            status=OWASPStatus.INCONCLUSIVE,
            severity="MEDIUM",
            description="Logging analysis requires log review (placeholder)",
            evidence={'note': 'Review logging implementation'},
            recommendation="Implement comprehensive security event logging",
            timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
        )
    
    def _test_log_injection(self) -> PentestResult:
        """Test log injection"""
        try:
            injection_payload = "test\n[CRITICAL] Admin access granted"
            response = requests.post(
                self.api_endpoint,
                json={"text": injection_payload},
                timeout=5
            )
            
            return PentestResult(
                owasp_category="A09: Security Logging Failures",
                test_name="Log injection",
                status=OWASPStatus.INCONCLUSIVE,
                severity="MEDIUM",
                description="Log injection requires log file analysis (placeholder)",
                evidence={'payload': injection_payload},
                recommendation="Sanitize log inputs and use structured logging",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception as e:
            return PentestResult(
                owasp_category="A09: Security Logging Failures",
                test_name="Log injection",
                status=OWASPStatus.INCONCLUSIVE,
                severity="MEDIUM",
                description=f"Error: {str(e)}",
                evidence={'error': str(e)},
                recommendation="Implement log sanitization",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
    
    def _test_ssrf_payload(self, payload: str) -> PentestResult:
        """Test SSRF payload"""
        try:
            response = requests.post(
                self.api_endpoint,
                json={"text": f"Fetch URL: {payload}"},
                timeout=5
            )
            
            response_text = response.text.lower()
            ssrf_indicators = ['localhost', '127.0.0.1', 'internal', 'private']
            
            vulnerable = any(indicator in response_text for indicator in ssrf_indicators)
            status = OWASPStatus.VULNERABLE if vulnerable else OWASPStatus.SECURE
            
            return PentestResult(
                owasp_category="A10: Server-Side Request Forgery",
                test_name=f"SSRF: {payload}",
                status=status,
                severity="HIGH" if vulnerable else "INFO",
                description=f"SSRF {'vulnerable' if vulnerable else 'secure'}",
                evidence={'payload': payload, 'vulnerable': vulnerable},
                recommendation="Validate and whitelist allowed URLs",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception as e:
            return PentestResult(
                owasp_category="A10: Server-Side Request Forgery",
                test_name=f"SSRF: {payload}",
                status=OWASPStatus.INCONCLUSIVE,
                severity="HIGH",
                description=f"Error: {str(e)}",
                evidence={'error': str(e), 'payload': payload},
                recommendation="Implement URL validation",
                timestamp=time.strftime("%Y-%m-%d %H:%M:%S")
            )
    
    def _generate_report(self) -> Dict[str, Any]:
        """Generate penetration test report"""
        total = len(self.results)
        vulnerable = sum(1 for r in self.results if r.status == OWASPStatus.VULNERABLE)
        secure = sum(1 for r in self.results if r.status == OWASPStatus.SECURE)
        inconclusive = sum(1 for r in self.results if r.status == OWASPStatus.INCONCLUSIVE)
        not_applicable = sum(1 for r in self.results if r.status == OWASPStatus.NOT_APPLICABLE)
        
        critical = sum(1 for r in self.results if r.severity == "CRITICAL")
        high = sum(1 for r in self.results if r.severity == "HIGH")
        medium = sum(1 for r in self.results if r.severity == "MEDIUM")
        
        return {
            'summary': {
                'total_tests': total,
                'vulnerable': vulnerable,
                'secure': secure,
                'inconclusive': inconclusive,
                'not_applicable': not_applicable,
                'severity_breakdown': {
                    'critical': critical,
                    'high': high,
                    'medium': medium
                }
            },
            'results': [
                {
                    'owasp_category': r.owasp_category,
                    'test_name': r.test_name,
                    'status': r.status.value,
                    'severity': r.severity,
                    'description': r.description,
                    'recommendation': r.recommendation,
                    'timestamp': r.timestamp
                }
                for r in self.results
            ],
            'details': {r.test_name: r.evidence for r in self.results}
        }

