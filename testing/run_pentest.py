"""
OWASP Top 10 Penetration Testing Runner
Executes comprehensive security penetration tests
"""

import sys
import os
import json
from datetime import datetime

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from testing.pentest_owasp import OWASPPentestSuite

def main():
    """Run penetration test suite"""
    print("=" * 80)
    print("OWASP Top 10 Penetration Testing Suite")
    print("=" * 80)
    print(f"Started at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
    
    base_url = os.getenv('API_BASE_URL', 'http://localhost:5001')
    print(f"Testing API at: {base_url}\n")
    
    pentest = OWASPPentestSuite(base_url=base_url)
    report = pentest.run_all_tests()
    
    print("\n" + "=" * 80)
    print("PENETRATION TEST RESULTS SUMMARY")
    print("=" * 80)
    print(f"Total Tests: {report['summary']['total_tests']}")
    print(f"Vulnerable: {report['summary']['vulnerable']}")
    print(f"Secure: {report['summary']['secure']}")
    print(f"Inconclusive: {report['summary']['inconclusive']}")
    print(f"Not Applicable: {report['summary']['not_applicable']}")
    print("\nSeverity Breakdown:")
    print(f"  Critical: {report['summary']['severity_breakdown']['critical']}")
    print(f"  High: {report['summary']['severity_breakdown']['high']}")
    print(f"  Medium: {report['summary']['severity_breakdown']['medium']}")
    print("=" * 80)
    
    print("\nDetailed Results:")
    print("-" * 80)
    for result in report['results']:
        status_symbol = {
            'VULNERABLE': '⚠',
            'SECURE': '✓',
            'INCONCLUSIVE': '?',
            'NOT_APPLICABLE': '-'
        }.get(result['status'], '?')
        
        print(f"{status_symbol} [{result['severity']}] {result['owasp_category']} - {result['test_name']}")
        print(f"  Description: {result['description']}")
        print(f"  Recommendation: {result['recommendation']}")
        print()
    
    output_file = f"pentest_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    with open(output_file, 'w') as f:
        json.dump(report, f, indent=2)
    
    print(f"\nFull report saved to: {output_file}")
    print(f"Completed at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    vulnerable_count = report['summary']['vulnerable']
    critical_count = report['summary']['severity_breakdown']['critical']
    
    if critical_count > 0:
        print(f"\n⚠️  WARNING: {critical_count} critical vulnerabilities found!")
        return 2
    elif vulnerable_count > 0:
        print(f"\n⚠️  WARNING: {vulnerable_count} vulnerabilities found!")
        return 1
    else:
        print("\n✓ No critical vulnerabilities found.")
        return 0

if __name__ == '__main__':
    sys.exit(main())

